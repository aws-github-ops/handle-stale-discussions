"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processComments = exports.processDiscussions = void 0;
const github = require("@actions/github");
const core = require("@actions/core");
const GithubDiscussionClient_1 = require("./GithubDiscussionClient");
const util_1 = require("./util");
const DAYS_UNTIL_STALE = parseInt(core.getInput('days-until-stale', { required: false })) || 7;
const PROPOSED_ANSWER_KEYWORD = '@bot proposed-answer';
const CLOSE_FOR_STALENESS_RESPONSE_TEXT = 'Closing the discussion for staleness';
const INSTRUCTIONS_TEXT = 'Please give a positive reaction (such as a thumbs up) to the proposed answer if it helped. '
    + 'If not, leave a negative reaction (such as a thumbs down) and leave a comment explaining why it did not help.'
    + '7 days to respond, etc';
const OWNER = github.context.repo.owner;
const REPO = github.context.repo.repo;
async function main() {
    const githubClient = new GithubDiscussionClient_1.GithubDiscussionClient(OWNER, REPO);
    await processDiscussions(githubClient);
}
async function processDiscussions(githubClient) {
    const discussionCategoryIDList = await githubClient.getAnswerableDiscussionCategoryIDs();
    console.log("Printing discussion category ID list ::  " + JSON.stringify(discussionCategoryIDList));
    for (const discussionCategoryID of discussionCategoryIDList) {
        const discussions = await githubClient.getDiscussionsMetaData(discussionCategoryID);
        discussions.edges?.map(async (discussion) => {
            var discussionId = discussion?.node?.id ? discussion?.node?.id : "";
            var discussionNum = discussion?.node?.number ? discussion.node.number : 0;
            if (discussionId === "" || discussionNum == 0) {
                core.warning(`Can not proceed checking discussion, discussionId is null!`);
                return;
            }
            else if (discussion?.node?.locked) {
                core.info(`Discussion ${discussionId} is locked, closing it as resolved`);
                githubClient.closeDiscussionAsResolved(discussionId);
                return;
            }
            else if (discussion?.node?.answer != null) {
                core.info(`This discussions has been answered, so closing it as resolved.`);
                githubClient.closeDiscussionAsResolved(discussionId);
            }
            else {
                await processComments(discussion, githubClient);
            }
        });
    }
}
exports.processDiscussions = processDiscussions;
async function processComments(discussion, githubClient) {
    const discussionId = discussion.node?.id ? discussion.node?.id : "";
    const discussionNum = discussion.node?.number ? discussion.node?.number : 0;
    const commentCount = await githubClient.getDiscussionCommentCount(OWNER, REPO, discussionNum);
    //const reactionsCount = await githubClient.getCommentReactionCount(OWNER,REPO, discussionNum, commentCount);
    const comments = await githubClient.getCommentsMetaData(discussionNum, commentCount);
    comments.edges?.map(async (comment) => {
        const commentText = comment?.node?.bodyText ? comment.node.bodyText : "";
        if ((0, util_1.containsText)(comment, PROPOSED_ANSWER_KEYWORD)) {
            if (!(0, util_1.hasInstructionsReply)(comment, discussion, INSTRUCTIONS_TEXT)) {
                await githubClient.addCommentToDiscussion(discussionId, INSTRUCTIONS_TEXT);
            }
            else if ((0, util_1.hasReply)(comment)) {
                await githubClient.addAttentionLabelToDiscussion(discussionId);
            }
            else if ((0, util_1.hasReaction)(comment)) {
                if ((0, util_1.containsNegativeReaction)(comment)) {
                    core.info("Negative reaction received. Adding attention label to receive further attention from a repository maintainer");
                    await githubClient.addAttentionLabelToDiscussion(discussionId);
                }
                else if ((0, util_1.containsPositiveReaction)(comment)) {
                    core.info("Positive reaction received. Marking discussion as answered, and editing answer to remove proposed answer keyword");
                    await closeAndMarkAsAnswered(comment, discussionId, githubClient);
                }
            }
            else if (!(0, util_1.hasReaction)(comment)) {
                if (!(0, util_1.hasReply)(comment) && (0, util_1.exceedsDaysUntilStale)(comment, DAYS_UNTIL_STALE)) {
                    await closeDiscussionForStaleness(discussionId, githubClient);
                }
            }
            else {
                core.debug("No answer proposed on comment, no action needed ");
            }
        }
    });
}
exports.processComments = processComments;
async function closeDiscussionForStaleness(discussionId, githubClient) {
    core.info("Discussion author has not responded in a while, so closing the discussion with a comment");
    await githubClient.addCommentToDiscussion(discussionId, CLOSE_FOR_STALENESS_RESPONSE_TEXT);
    await githubClient.closeDiscussionAsOutdated(discussionId);
}
async function closeAndMarkAsAnswered(comment, discussionId, githubClient) {
    const bodyText = comment?.node?.bodyText;
    const commentId = comment?.node?.id;
    const updatedAnswerText = bodyText.replace(PROPOSED_ANSWER_KEYWORD, 'Answer: ');
    await githubClient.updateDiscussionComment(commentId, updatedAnswerText);
    await githubClient.markDiscussionCommentAsAnswer(commentId);
    await githubClient.closeDiscussionAsResolved(discussionId);
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMENBQTBDO0FBQzFDLHNDQUFzQztBQUN0QyxxRUFBa0U7QUFDbEUsaUNBQThKO0FBRzlKLE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMvRixNQUFNLHVCQUF1QixHQUFHLHNCQUFzQixDQUFDO0FBQ3ZELE1BQU0saUNBQWlDLEdBQUcsc0NBQXNDLENBQUM7QUFDakYsTUFBTSxpQkFBaUIsR0FBRyw2RkFBNkY7TUFDbkgsK0dBQStHO01BQy9HLHdCQUF3QixDQUFDO0FBQzdCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztBQUN4QyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFFdEMsS0FBSyxVQUFVLElBQUk7SUFFakIsTUFBTSxZQUFZLEdBQUcsSUFBSSwrQ0FBc0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0QsTUFBTSxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRU0sS0FBSyxVQUFVLGtCQUFrQixDQUFDLFlBQW9DO0lBQzNFLE1BQU0sd0JBQXdCLEdBQWEsTUFBTSxZQUFZLENBQUMsa0NBQWtDLEVBQUUsQ0FBQztJQUNuRyxPQUFPLENBQUMsR0FBRyxDQUFDLDJDQUEyQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDO0lBRXBHLEtBQUssTUFBTSxvQkFBb0IsSUFBSSx3QkFBd0IsRUFBRTtRQUMzRCxNQUFNLFdBQVcsR0FBRyxNQUFNLFlBQVksQ0FBQyxz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LE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRyxDQUFDO0lBQ3JDLE1BQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNoRixNQUFNLFlBQVksQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUN6RSxNQUFNLFlBQVksQ0FBQyw2QkFBNkIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1RCxNQUFNLFlBQVksQ0FBQyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM3RCxDQUFDO0FBRUQsSUFBSSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBvY3Rva2l0IGZyb20gJ0BvY3Rva2l0L2dyYXBocWwtc2NoZW1hJztcbmltcG9ydCAqIGFzIGdpdGh1YiBmcm9tICdAYWN0aW9ucy9naXRodWInO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tICdAYWN0aW9ucy9jb3JlJztcbmltcG9ydCB7IEdpdGh1YkRpc2N1c3Npb25DbGllbnQgfSBmcm9tIFwiLi9HaXRodWJEaXNjdXNzaW9uQ2xpZW50XCI7XG5pbXBvcnQgeyBjb250YWluc05lZ2F0aXZlUmVhY3Rpb24sIGNvbnRhaW5zUG9zaXRpdmVSZWFjdGlvbiwgY29udGFpbnNUZXh0LCBleGNlZWRzRGF5c1VudGlsU3RhbGUsIGhhc0luc3RydWN0aW9uc1JlcGx5LCBoYXNSZWFjdGlvbiwgaGFzUmVwbHkgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgRGlzY3Vzc2lvbiwgRGlzY3Vzc2lvbkNvbW1lbnRFZGdlIH0gZnJvbSAnLi9nZW5lcmF0ZWQvZ3JhcGhxbCc7XG5cbmNvbnN0IERBWVNfVU5USUxfU1RBTEUgPSBwYXJzZUludChjb3JlLmdldElucHV0KCdkYXlzLXVudGlsLXN0YWxlJywgeyByZXF1aXJlZDogZmFsc2UgfSkpIHx8IDc7XG5jb25zdCBQUk9QT1NFRF9BTlNXRVJfS0VZV09SRCA9ICdAYm90IHByb3Bvc2VkLWFuc3dlcic7XG5jb25zdCBDTE9TRV9GT1JfU1RBTEVORVNTX1JFU1BPTlNFX1RFWFQgPSAnQ2xvc2luZyB0aGUgZGlzY3Vzc2lvbiBmb3Igc3RhbGVuZXNzJztcbmNvbnN0IElOU1RSVUNUSU9OU19URVhUID0gJ1BsZWFzZSBnaXZlIGEgcG9zaXRpdmUgcmVhY3Rpb24gKHN1Y2ggYXMgYSB0aHVtYnMgdXApIHRvIHRoZSBwcm9wb3NlZCBhbnN3ZXIgaWYgaXQgaGVscGVkLiAnXG4gICsgJ0lmIG5vdCwgbGVhdmUgYSBuZWdhdGl2ZSByZWFjdGlvbiAoc3VjaCBhcyBhIHRodW1icyBkb3duKSBhbmQgbGVhdmUgYSBjb21tZW50IGV4cGxhaW5pbmcgd2h5IGl0IGRpZCBub3QgaGVscC4nXG4gICsgJzcgZGF5cyB0byByZXNwb25kLCBldGMnO1xuY29uc3QgT1dORVIgPSBnaXRodWIuY29udGV4dC5yZXBvLm93bmVyO1xuY29uc3QgUkVQTyA9IGdpdGh1Yi5jb250ZXh0LnJlcG8ucmVwbztcblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcblxuICBjb25zdCBnaXRodWJDbGllbnQgPSBuZXcgR2l0aHViRGlzY3Vzc2lvbkNsaWVudChPV05FUiwgUkVQTyk7XG4gIGF3YWl0IHByb2Nlc3NEaXNjdXNzaW9ucyhnaXRodWJDbGllbnQpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0Rpc2N1c3Npb25zKGdpdGh1YkNsaWVudDogR2l0aHViRGlzY3Vzc2lvbkNsaWVudCkge1xuICBjb25zdCBkaXNjdXNzaW9uQ2F0ZWdvcnlJRExpc3Q6IHN0cmluZ1tdID0gYXdhaXQgZ2l0aHViQ2xpZW50LmdldEFuc3dlcmFibGVEaXNjdXNzaW9uQ2F0ZWdvcnlJRHMoKTtcbiAgY29uc29sZS5sb2coXCJQcmludGluZyBkaXNjdXNzaW9uIGNhdGVnb3J5IElEIGxpc3QgOjogIFwiICsgSlNPTi5zdHJpbmdpZnkoZGlzY3Vzc2lvbkNhdGVnb3J5SURMaXN0KSk7XG4gIFxuICBmb3IgKGNvbnN0IGRpc2N1c3Npb25DYXRlZ29yeUlEIG9mIGRpc2N1c3Npb25DYXRlZ29yeUlETGlzdCkge1xuICAgIGNvbnN0IGRpc2N1c3Npb25zID0gYXdhaXQgZ2l0aHViQ2xpZW50LmdldERpc2N1c3Npb25zTWV0YURhdGEoZGlzY3Vzc2lvbkNhdGVnb3J5SUQpO1xuXG4gICAgZGlzY3Vzc2lvbnMuZWRnZXM/Lm1hcChhc3luYyBkaXNjdXNzaW9uID0+IHtcbiAgICAgIHZhciBkaXNjdXNzaW9uSWQgPSBkaXNjdXNzaW9uPy5ub2RlPy5pZCA/IGRpc2N1c3Npb24/Lm5vZGU/LmlkIDogXCJcIjtcbiAgICAgIHZhciBkaXNjdXNzaW9uTnVtID0gZGlzY3Vzc2lvbj8ubm9kZT8ubnVtYmVyID8gZGlzY3Vzc2lvbi5ub2RlLm51bWJlciA6IDA7XG4gICAgICBpZiAoZGlzY3Vzc2lvbklkID09PSBcIlwiIHx8IGRpc2N1c3Npb25OdW0gPT0gMCkge1xuICAgICAgICBjb3JlLndhcm5pbmcoYENhbiBub3QgcHJvY2VlZCBjaGVja2luZyBkaXNjdXNzaW9uLCBkaXNjdXNzaW9uSWQgaXMgbnVsbCFgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoZGlzY3Vzc2lvbj8ubm9kZT8ubG9ja2VkKSB7XG4gICAgICAgIGNvcmUuaW5mbyhgRGlzY3Vzc2lvbiAke2Rpc2N1c3Npb25JZH0gaXMgbG9ja2VkLCBjbG9zaW5nIGl0IGFzIHJlc29sdmVkYCk7XG4gICAgICAgIGdpdGh1YkNsaWVudC5jbG9zZURpc2N1c3Npb25Bc1Jlc29sdmVkKGRpc2N1c3Npb25JZCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKGRpc2N1c3Npb24/Lm5vZGU/LmFuc3dlciAhPSBudWxsKSB7XG4gICAgICAgIGNvcmUuaW5mbyhgVGhpcyBkaXNjdXNzaW9ucyBoYXMgYmVlbiBhbnN3ZXJlZCwgc28gY2xvc2luZyBpdCBhcyByZXNvbHZlZC5gKTtcbiAgICAgICAgZ2l0aHViQ2xpZW50LmNsb3NlRGlzY3Vzc2lvbkFzUmVzb2x2ZWQoZGlzY3Vzc2lvbklkKTtcblxuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGF3YWl0IHByb2Nlc3NDb21tZW50cyhkaXNjdXNzaW9uISwgZ2l0aHViQ2xpZW50KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0NvbW1lbnRzKGRpc2N1c3Npb246IG9jdG9raXQuRGlzY3Vzc2lvbkVkZ2UsIGdpdGh1YkNsaWVudDogR2l0aHViRGlzY3Vzc2lvbkNsaWVudCkge1xuICBjb25zdCBkaXNjdXNzaW9uSWQgPSBkaXNjdXNzaW9uLm5vZGU/LmlkID8gZGlzY3Vzc2lvbi5ub2RlPy5pZCA6IFwiXCI7XG4gIGNvbnN0IGRpc2N1c3Npb25OdW0gPSBkaXNjdXNzaW9uLm5vZGU/Lm51bWJlciA/IGRpc2N1c3Npb24ubm9kZT8ubnVtYmVyIDogMDtcbiAgY29uc3QgY29tbWVudENvdW50ID0gYXdhaXQgZ2l0aHViQ2xpZW50LmdldERpc2N1c3Npb25Db21tZW50Q291bnQoT1dORVIsIFJFUE8sIGRpc2N1c3Npb25OdW0pO1xuICAvL2NvbnN0IHJlYWN0aW9uc0NvdW50ID0gYXdhaXQgZ2l0aHViQ2xpZW50LmdldENvbW1lbnRSZWFjdGlvbkNvdW50KE9XTkVSLFJFUE8sIGRpc2N1c3Npb25OdW0sIGNvbW1lbnRDb3VudCk7XG5cbiAgY29uc3QgY29tbWVudHMgPSBhd2FpdCBnaXRodWJDbGllbnQuZ2V0Q29tbWVudHNNZXRhRGF0YShkaXNjdXNzaW9uTnVtLCBjb21tZW50Q291bnQpO1xuXG4gIGNvbW1lbnRzLmVkZ2VzPy5tYXAoYXN5bmMgY29tbWVudCA9PiB7XG4gICAgY29uc3QgY29tbWVudFRleHQgPSBjb21tZW50Py5ub2RlPy5ib2R5VGV4dCA/IGNvbW1lbnQubm9kZS5ib2R5VGV4dCA6IFwiXCI7XG4gICAgaWYgKGNvbnRhaW5zVGV4dChjb21tZW50ISwgUFJPUE9TRURfQU5TV0VSX0tFWVdPUkQpKSB7XG4gICAgICBpZiAoICFoYXNJbnN0cnVjdGlvbnNSZXBseShjb21tZW50ISwgZGlzY3Vzc2lvbiwgSU5TVFJVQ1RJT05TX1RFWFQpICkge1xuICAgICAgICBhd2FpdCBnaXRodWJDbGllbnQuYWRkQ29tbWVudFRvRGlzY3Vzc2lvbihkaXNjdXNzaW9uSWQsIElOU1RSVUNUSU9OU19URVhUKTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKCBoYXNSZXBseShjb21tZW50ISkgKSB7XG4gICAgICAgIGF3YWl0IGdpdGh1YkNsaWVudC5hZGRBdHRlbnRpb25MYWJlbFRvRGlzY3Vzc2lvbihkaXNjdXNzaW9uSWQpO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoIGhhc1JlYWN0aW9uKGNvbW1lbnQhKSApIHtcbiAgICAgICAgaWYgKGNvbnRhaW5zTmVnYXRpdmVSZWFjdGlvbihjb21tZW50ISkpIHtcbiAgICAgICAgICBjb3JlLmluZm8oXCJOZWdhdGl2ZSByZWFjdGlvbiByZWNlaXZlZC4gQWRkaW5nIGF0dGVudGlvbiBsYWJlbCB0byByZWNlaXZlIGZ1cnRoZXIgYXR0ZW50aW9uIGZyb20gYSByZXBvc2l0b3J5IG1haW50YWluZXJcIik7XG4gICAgICAgICAgYXdhaXQgZ2l0aHViQ2xpZW50LmFkZEF0dGVudGlvbkxhYmVsVG9EaXNjdXNzaW9uKGRpc2N1c3Npb25JZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoY29udGFpbnNQb3NpdGl2ZVJlYWN0aW9uKGNvbW1lbnQhKSkge1xuICAgICAgICAgIGNvcmUuaW5mbyhcIlBvc2l0aXZlIHJlYWN0aW9uIHJlY2VpdmVkLiBNYXJraW5nIGRpc2N1c3Npb24gYXMgYW5zd2VyZWQsIGFuZCBlZGl0aW5nIGFuc3dlciB0byByZW1vdmUgcHJvcG9zZWQgYW5zd2VyIGtleXdvcmRcIik7XG4gICAgICAgICAgYXdhaXQgY2xvc2VBbmRNYXJrQXNBbnN3ZXJlZChjb21tZW50ISwgZGlzY3Vzc2lvbklkLCBnaXRodWJDbGllbnQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIGlmICghaGFzUmVhY3Rpb24oY29tbWVudCEpKXtcbiAgICAgICAgaWYgKCFoYXNSZXBseShjb21tZW50ISkgJiYgZXhjZWVkc0RheXNVbnRpbFN0YWxlKGNvbW1lbnQhLCBEQVlTX1VOVElMX1NUQUxFKSkge1xuICAgICAgICAgIGF3YWl0IGNsb3NlRGlzY3Vzc2lvbkZvclN0YWxlbmVzcyhkaXNjdXNzaW9uSWQsIGdpdGh1YkNsaWVudCk7XG4gICAgICAgIH0gXG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29yZS5kZWJ1ZyhcIk5vIGFuc3dlciBwcm9wb3NlZCBvbiBjb21tZW50LCBubyBhY3Rpb24gbmVlZGVkIFwiKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjbG9zZURpc2N1c3Npb25Gb3JTdGFsZW5lc3MoZGlzY3Vzc2lvbklkOiBzdHJpbmcsIGdpdGh1YkNsaWVudDogR2l0aHViRGlzY3Vzc2lvbkNsaWVudCkge1xuICBjb3JlLmluZm8oXCJEaXNjdXNzaW9uIGF1dGhvciBoYXMgbm90IHJlc3BvbmRlZCBpbiBhIHdoaWxlLCBzbyBjbG9zaW5nIHRoZSBkaXNjdXNzaW9uIHdpdGggYSBjb21tZW50XCIpO1xuICBhd2FpdCBnaXRodWJDbGllbnQuYWRkQ29tbWVudFRvRGlzY3Vzc2lvbihkaXNjdXNzaW9uSWQsIENMT1NFX0ZPUl9TVEFMRU5FU1NfUkVTUE9OU0VfVEVYVCk7XG4gIGF3YWl0IGdpdGh1YkNsaWVudC5jbG9zZURpc2N1c3Npb25Bc091dGRhdGVkKGRpc2N1c3Npb25JZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsb3NlQW5kTWFya0FzQW5zd2VyZWQoY29tbWVudDogRGlzY3Vzc2lvbkNvbW1lbnRFZGdlLCBkaXNjdXNzaW9uSWQ6IHN0cmluZywgZ2l0aHViQ2xpZW50OiBHaXRodWJEaXNjdXNzaW9uQ2xpZW50KSB7XG4gIGNvbnN0IGJvZHlUZXh0ID0gY29tbWVudD8ubm9kZT8uYm9keVRleHQhO1xuICBjb25zdCBjb21tZW50SWQgPSBjb21tZW50Py5ub2RlPy5pZCE7XG4gIGNvbnN0IHVwZGF0ZWRBbnN3ZXJUZXh0ID0gYm9keVRleHQucmVwbGFjZShQUk9QT1NFRF9BTlNXRVJfS0VZV09SRCwgJ0Fuc3dlcjogJyk7XG4gIGF3YWl0IGdpdGh1YkNsaWVudC51cGRhdGVEaXNjdXNzaW9uQ29tbWVudChjb21tZW50SWQsIHVwZGF0ZWRBbnN3ZXJUZXh0KTtcbiAgYXdhaXQgZ2l0aHViQ2xpZW50Lm1hcmtEaXNjdXNzaW9uQ29tbWVudEFzQW5zd2VyKGNvbW1lbnRJZCk7XG4gIGF3YWl0IGdpdGh1YkNsaWVudC5jbG9zZURpc2N1c3Npb25Bc1Jlc29sdmVkKGRpc2N1c3Npb25JZCk7XG59XG5cbm1haW4oKTtcbiJdfQ==